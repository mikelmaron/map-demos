var times = ['2002-04-18T00:00:00', '2002-05-10T00:00:00', '2002-08-16T00:00:00', '2002-09-16T00:00:00', '2002-10-16T00:00:00', '2002-11-16T00:00:00', '2002-12-16T00:00:00', '2003-01-16T00:00:00', '2003-02-15T00:00:00', '2003-03-16T00:00:00', '2003-04-16T00:00:00', '2003-05-11T00:00:00', '2003-07-16T00:00:00', '2003-08-16T00:00:00', '2003-09-16T00:00:00', '2003-10-16T00:00:00', '2003-11-16T00:00:00', '2003-12-16T00:00:00', '2004-01-07T00:00:00', '2004-02-17T00:00:00', '2004-03-16T00:00:00', '2004-04-16T00:00:00', '2004-05-16T00:00:00', '2004-06-16T00:00:00', '2004-07-16T00:00:00', '2004-08-16T00:00:00', '2004-09-16T00:00:00', '2004-10-16T00:00:00', '2004-11-16T00:00:00', '2004-12-16T00:00:00', '2005-01-16T00:00:00', '2005-02-15T00:00:00', '2005-03-16T00:00:00', '2005-04-16T00:00:00', '2005-05-16T00:00:00', '2005-06-16T00:00:00', '2005-07-16T00:00:00', '2005-08-16T00:00:00', '2005-09-16T00:00:00', '2005-10-16T00:00:00', '2005-11-16T00:00:00', '2005-12-16T00:00:00', '2006-01-16T00:00:00', '2006-02-15T00:00:00', '2006-03-16T00:00:00', '2006-04-16T00:00:00', '2006-05-16T00:00:00', '2006-06-16T00:00:00', '2006-07-16T00:00:00', '2006-08-16T00:00:00', '2006-09-16T00:00:00', '2006-10-16T00:00:00', '2006-11-16T00:00:00', '2006-12-16T00:00:00', '2007-01-16T00:00:00', '2007-02-14T00:00:00', '2007-03-16T00:00:00', '2007-04-16T00:00:00', '2007-05-16T00:00:00', '2007-06-16T00:00:00', '2007-07-16T00:00:00', '2007-08-16T00:00:00', '2007-09-16T00:00:00', '2007-10-16T00:00:00', '2007-11-16T00:00:00', '2007-12-16T00:00:00', '2008-01-16T00:00:00', '2008-02-15T00:00:00', '2008-03-16T00:00:00', '2008-04-16T00:00:00', '2008-05-16T00:00:00', '2008-06-16T00:00:00', '2008-07-16T00:00:00', '2008-08-16T00:00:00', '2008-09-16T00:00:00', '2008-10-16T00:00:00', '2008-11-16T00:00:00', '2008-12-16T00:00:00', '2009-01-16T00:00:00', '2009-02-15T00:00:00', '2009-03-16T00:00:00', '2009-04-16T00:00:00', '2009-05-16T00:00:00', '2009-06-16T00:00:00', '2009-07-16T00:00:00', '2009-08-16T00:00:00', '2009-09-16T00:00:00', '2009-10-16T00:00:00', '2009-11-16T00:00:00', '2009-12-16T00:00:00', '2010-01-16T00:00:00', '2010-02-15T00:00:00', '2010-03-16T00:00:00', '2010-04-16T00:00:00', '2010-05-16T00:00:00', '2010-06-16T00:00:00', '2010-07-16T00:00:00', '2010-08-16T00:00:00', '2010-09-16T00:00:00', '2010-10-16T00:00:00', '2010-11-16T00:00:00', '2010-12-14T00:00:00', '2011-02-18T00:00:00', '2011-03-16T00:00:00', '2011-04-16T00:00:00', '2011-05-16T00:00:00', '2011-07-18T00:00:00', '2011-08-16T00:00:00', '2011-09-16T00:00:00', '2011-10-16T00:00:00', '2011-10-31T00:00:00', '2011-12-28T00:00:00', '2012-01-16T00:00:00', '2012-02-15T00:00:00', '2012-03-16T00:00:00', '2012-04-04T00:00:00', '2012-06-16T00:00:00', '2012-07-16T00:00:00', '2012-08-16T00:00:00', '2012-09-13T00:00:00', '2012-11-18T00:00:00', '2012-12-16T00:00:00', '2013-01-16T00:00:00', '2013-02-14T00:00:00', '2013-04-21T00:00:00', '2013-05-16T00:00:00', '2013-06-16T00:00:00', '2013-07-16T00:00:00', '2013-10-16T00:00:00', '2013-11-16T00:00:00', '2013-12-16T00:00:00', '2014-01-09T00:00:00', '2014-03-17T00:00:00', '2014-04-16T00:00:00', '2014-05-16T00:00:00', '2014-06-13T00:00:00', '2014-08-16T00:00:00', '2014-09-16T00:00:00', '2014-10-16T00:00:00', '2014-11-16T00:00:00', '2015-01-22T00:00:00', '2015-02-15T00:00:00', '2015-03-16T00:00:00', '2015-04-16T00:00:00', '2015-04-27T00:00:00', '2015-07-15T00:00:00', '2015-08-16T00:00:00', '2015-09-14T00:00:00', '2015-12-23T00:00:00', '2016-01-16T00:00:00', '2016-02-14T00:00:00', '2016-03-16T00:00:00', '2016-05-20T00:00:00', '2016-06-16T00:00:00', '2016-07-15T00:00:00', '2016-08-21T00:00:00', '2016-11-27T00:00:00', '2016-12-24T00:00:00', '2017-01-21T00:00:00', '2017-03-31T00:00:00', '2017-04-24T00:00:00', '2017-05-13T00:00:00', '2017-06-10T00:00:00', '2018-06-16T00:00:00', '2018-07-10T00:00:00', '2018-10-31T00:00:00', '2018-11-16T00:00:00', '2018-12-16T00:00:00', '2019-01-16T00:00:00', '2019-02-15T00:00:00', '2019-03-16T00:00:00', '2019-04-16T00:00:00', '2019-05-16T00:00:00', '2019-06-16T00:00:00', '2019-07-16T00:00:00', '2019-08-16T00:00:00', '2019-09-16T00:00:00', '2019-10-16T00:00:00', '2019-11-16T00:00:00', '2019-12-16T00:00:00', '2020-01-16T00:00:00', '2020-02-15T00:00:00', '2020-03-16T00:00:00', '2020-04-16T00:00:00', '2020-05-16T00:00:00', '2020-06-16T00:00:00', '2020-07-16T00:00:00', '2020-08-16T00:00:00', '2020-09-16T00:00:00', '2020-10-16T00:00:00', '2020-11-16T00:00:00', '2020-12-16T00:00:00', '2021-01-16T00:00:00', '2021-02-15T00:00:00', '2021-03-16T00:00:00', '2021-04-16T00:00:00', '2021-05-16T00:00:00', '2021-06-16T00:00:00', '2021-07-16T00:00:00', '2021-08-16T00:00:00', '2021-09-16T00:00:00', '2021-10-16T00:00:00', '2021-11-16T00:00:00', '2021-12-16T00:00:00', '2022-01-16T00:00:00', '2022-02-15T00:00:00', '2022-03-16T00:00:00', '2022-04-16T00:00:00', '2022-05-16T00:00:00', '2022-06-16T00:00:00', '2022-07-16T00:00:00', '2022-08-16T00:00:00'];

function createLayers() {
    map.addSource('greenland-2011', {
        type: 'vector',
        url: 'mapbox://earthrise.0lfqocjh'
    });

    map.addSource('greenland-2022', {
        type: 'vector',
        url: 'mapbox://earthrise.2kvqqae0'
    });



    times.forEach(time =>  {
        map.addLayer({
            'id': time,
            'type': 'fill',
            'source': (time < '2012-01-01T00:00:00' ? 'greenland-2011' : 'greenland-2022'),
            'source-layer': (time < '2012-01-01T00:00:00' ? 'interpolated_greenland_grace_data_clipped_2011' : 'interpolated_greenland_grace_data_clipped_2022'),
            'paint': {
                'fill-color': [
                    "interpolate",
                    ["linear"],
                    ["get", "lwe_thickness"],
                    -587.3,
                    "rgba(103,0,30,255)",
                    -402.9,
                    "rgba(142,13,38,255)",
                    -331,
                    "rgba(174,36,48,255)",
                    -231.2,
                    "rgba(216,103,85,255)",
                    -222.5,
                    "rgba(232,139,111,255)",
                    -178.9,
                    "rgba(243,172,142,255)",
                    -68.71,
                    "rgba(249,200,175,255)",
                    -30.59,
                    "rgba(251,223,207,255)",
                    -28.77,
                    "rgba(246,236,231,255)",
                    -9.539,
                    "rgba(235,239,241,255)",
                    -4.491,
                    "rgba(215,232,240,255)",
                    -3.386,
                    "rgba(188,218,234,255)",
                    -1.752,
                    "rgba(153,200,223,255)",
                    5.054,
                    "rgba(118,178,212,255)",
                    35.85,
                    "rgba(81,153,198,255)",
                    38.36,
                    "rgba(54,128,185,255)",
                    42.43,
                    "rgba(35,103,166,255)",
                    46.65,
                    "rgba(20,76,135,255)",
                    46.66,
                    "rgba(5,48,97,255)"
                  ],
                'fill-opacity': 0
            },
            'filter': [
                "all",
                [
                  "match",
                  ["get", "time"],
                  [time],
                  true,
                  false
                ]
              ]

        });   
    });
}

var chapters = [];
var chapter = {};
/* start */
chapter.hidden = true;
chapter.id = "start";
chapter.location = {
    center: [-28.16976, 28.07560],
    zoom: 1.69,
    pitch: 1.03,
    bearing: 0.00,
    duration: 1          
}
chapter.onChapterEnter = [];
chapter.onChapterExit = [];
chapters.push(chapter);

/* load */
chapter = {};
chapter.hidden = true;
chapter.id = "load";
chapter.location = {
    center: [-41.79448, 62.45858],
    zoom: 3.99,
    pitch: 35.53,
    bearing: 0.00,
    duration: 2000          
}
chapter.onChapterEnter = [
    {
        layer: times[0],
        opacity: 0
    }
];
chapter.onChapterExit = [];
chapters.push(chapter);


for (var i = 0; i < times.length; i++) {
    chapter = {};
    chapter.hidden = true;
    var time = times[i];
    chapter.id = time;

    if (i == 20) {
        chapter.location = {
            center: [-40.54776, 72.85149],
            zoom: 3.3,
            pitch: 0.00,
            bearing: 0.00,
            duration: 50 * (30000 / times.length)
        }
    } else if (i ==70) {
        chapter.location = {
            center: [-40.54776, 72.85149],
            zoom: 3.8,
            pitch: 0.00,
            bearing: 0.00,
            duration: (times.length-70) * (30000 / times.length)          
        }
    }

    chapter.delay = 30000 / times.length;

    chapter.onChapterEnter = [
        {
            layer: time,
            opacity: 0.5
        }
    ];
    chapter.onChapterExit = [];
    if (i > 2) {
        chapter.onChapterExit.push({
            layer: times[i-2],
            opacity: 0
        });
    }
    chapters.push(chapter);
}

/* pause */
chapter = {};
chapter.hidden = true;
chapter.id = "pause";
chapter.delay = 4000;
chapter.onChapterEnter = [];
chapter.onChapterExit = [];
chapters.push(chapter);

/* close */
chapter = {};
chapter.id = "close";
chapter.hidden = true;
chapter.location = {
    center: [-28.16976, 28.07560],
    zoom: 1.69,
    pitch: 1.03,
    bearing: 0.00,
    duration: 2000          
}
chapter.onChapterEnter = [];
chapter.onChapterExit = [];
times.forEach(t => {
    chapter.onChapterEnter.push({layer: t, opacity: 0});
});
chapters.push(chapter);


var config = {
    style: 'mapbox://styles/earthrise/clchzj050001i14qr5orncz2v',
    accessToken: 'pk.eyJ1IjoiZWFydGhyaXNlIiwiYSI6ImNqeDExNmtrZzAwM2E0OW16eHZ1dzg1eWEifQ.8LTFXyY-n7OsZOoWN9ONPQ',
    showMarkers: false,
    markerColor: '#3FB1CE',
    //projection: 'equirectangular',
    //Read more about available projections here
    //https://docs.mapbox.com/mapbox-gl-js/example/projections/
    inset: false,
    theme: 'dark',
    use3dTerrain: false, //set true for enabling 3D maps.
    auto: true,
    title: '',
    subtitle: '',
    byline: '',
    footer: '',
    onMapLoad: 'createLayers',
    chapters: chapters
};
